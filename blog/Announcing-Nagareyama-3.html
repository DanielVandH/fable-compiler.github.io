<html><head><title>Fable Blog</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="twitter:title" content="Fable"/><meta name="twitter:description" content="F# to JS compiler"/><meta name="twitter:image" content="https://fable.io/img/fable_logo.png"/><meta name="twitter:card" content="summary_large_image"/><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,300,600,700|Roboto+Mono|Fira+Code|Open+Sans:400,300,600,700"/><script src="https://kit.fontawesome.com/f1c8a90b9d.js"></script><link rel="stylesheet" type="text/css" href="/css/styles.css"/><link rel="stylesheet" type="text/css" href="/css/prism.css"/><link rel="shortcut icon" href="/img/fable.ico"/></head><body><nav class="navbar"><div class="navbar-brand"><a class="navbar-item is-size-4" href="/" style="background-color:rgba(0,0,0,0.5);color:dodgerblue;font-weight:600">Fable</a><div class="navbar-burger" data-target="navMenu"><span></span><span></span><span></span></div></div><div id="navMenu" class=" navbar-menu"><div class="navbar-start"><a class=" navbar-item" href="/docs">Docs</a><a class=" navbar-item is-active" href="/blog">Blog</a><a class=" navbar-item" href="/repl">REPL</a><a class=" navbar-item" href="/community">Community</a><a class=" navbar-item" href="/fableconf">FableConf</a></div><div class="navbar-end"><div class="field is-grouped"><a class="navbar-item" href="https://gitter.im/fable-compiler/Fable" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-gitter"></i></span></a><a class="navbar-item" href="https://github.com/fable-compiler/fable" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-github"></i></span></a><a class="navbar-item" href="https://twitter.com/FableCompiler" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-twitter"></i></span></a><a class="navbar-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-youtube"></i></span></a></div></div></div></nav><div class="markdown blog" style="overflow:hidden"><div class="fable-header-minimal"><figure class="image" style="max-width:200px;margin:20px auto"><img class="fable-logo" src="/img/fable_logo.png"/></figure></div><div style="margin-top:1.6rem"><div class="columns"><div class="column"></div><div class="column is-two-thirds"><div class="post_date" style="margin:5px;margin-bottom:2em"><i class=" far fa-calendar"></i> November 20, 2020</div><div class="content" style="margin:5px"><p>This is the third post in the &quot;Announcing Nagareyama (Fable 3)&quot; series. You can check the previous articles below:</p>
<ul>
<li><a href="https://fable.io/blog/Announcing-Nagareyama-1.html">Announcing Nagareyama I: Tooling</a></li>
<li><a href="https://fable.io/blog/Announcing-Nagareyama-2.html">Announcing Nagareyama II: Code Generation</a></li>
</ul>
<p>This time we will be focusing on the actual new features of Nagareyama. There are not so many because we&#39;ve been focusing on the tooling improvements for this release, but there are still a couple of interesting surprises so let&#39;s go through them together!</p>
<h2><a name="plugins-" class="anchor" href="#plugins-">Plugins!</a></h2><p>Plugins are probably the most important new feature in Fable 3 but they&#39;re actually a comeback: Fable 1 already supported them. Unfortunately, their design was not good and only a few users could take some advantage of them. Because of this, plugins were removed during the Fable 2 rewrite. We hope the design issues have been fixed and we are confident plugins are going to be much more useful to Fable developers.</p>
<p>Why does Fable need plugins? Because one of Fable&#39;s goals is to interop well with JS code and tooling. Sometimes, JS tooling expects code to be written in a particular way that differs to the code generated by Fable. This poses a dilemma when developing the compiler: Do we change the code generation to fit this particular tool? Or do we add some magic for the specific use case, likely complicating things both for Fable maintainers and users? Or do we try to resolve the problem with code even if it results in non-idiomatic F# or conflicts with the type-checker?</p>
<p>Plugins are a way to solve this dilemma: we can add some magic to manipulate the generated code for this specific case, while keeping the Fable codebase cleaner. The most obvious example and the first plugin of the Nagareyama-gen are React components. On first sight, <a href="https://en.reactjs.org/docs/components-and-props.html#function-and-class-components">React function components</a> look very similar to F# code. I will spare you of the details (you can have a look at this <a href="https://github.com/fable-compiler/fable-react/pull/188">long discussion</a> if interested) but there are actually many nuances that have caused many problems. Last week at .NET Conf, <a href="https://twitter.com/zaid_ajaj">Zaid Ajaj</a> presented a new way of creating React components simply by decorating a function with an attribute using Nagareyama plugins, as in:</p>
<pre><code class="language-fsharp"><span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">ReactComponent</span><span class="token punctuation">>]</span></span>
<span class="token keyword">let</span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">)</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    Html<span class="token punctuation">.</span>div <span class="token punctuation">[</span>
        prop<span class="token punctuation">.</span>style <span class="token punctuation">[</span> style<span class="token punctuation">.</span>padding <span class="token number">20</span> <span class="token punctuation">]</span>
        prop<span class="token punctuation">.</span>children <span class="token punctuation">[</span>
            Html<span class="token punctuation">.</span>h1 count
            Html<span class="token punctuation">.</span>button <span class="token punctuation">[</span>
                prop<span class="token punctuation">.</span>text <span class="token string">"Increment"</span>
                prop<span class="token punctuation">.</span>onClick <span class="token punctuation">(</span><span class="token keyword">fun</span> _ <span class="token operator">-></span> <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
</code></pre>
<p>If you haven&#39;t <a href="https://www.youtube.com/watch?v=a6Ct3CM_lj4">watched his presentation yet</a>, please do it. It&#39;s a great introduction to creating React apps using F# and <a href="https://zaid-ajaj.github.io/Feliz/">Feliz</a> and Zaid is an awesome presenter!</p>
<h2><a name="witnesses" class="anchor" href="#witnesses">Witnesses</a></h2><p>It may be a hard-sell to promote this as a new feature, as it is something &quot;hidden&quot; int the F# compiler and you probably won&#39;t notice it all in your Fable code. It is however, one of the biggest improvements in Fable 3 and it has to do with <a href="https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/generics/statically-resolved-type-parameters">SRTP</a> resolution. So far, SRTP were resolved internally by the F# compiler in an opaque way, and because of this Fable and other F#-to-X compilers had to do their own resolution, rendering different results in some situations. Don Syme has been working a lot to change this and now, thanks to the witnesses the F# compiler exposes the information necessary to make sure Fable resolves SRTP in the same way F# does and avoiding compilation errors because of the use of advanced patterns. You can read more about <a href="https://github.com/fsharp/fslang-design/blob/master/FSharp-5.0/FS-1071-witness-passing-quotations.md">witnesses in F# here</a>.</p>
<h2><a name="mangle-interfaces" class="anchor" href="#mangle-interfaces">Mangle interfaces</a></h2><p>If you&#39;ve read the documentation about <a href="https://fable.io/docs/communicate/fable-from-js.html#Name-mangling">calling Fable code from JS</a> or inspected the generated JS code, you&#39;ll know that Fable detaches and mangles instance members. This is necessary for several reasons like overload resolution or tree shaking. But an exception, interface members, was introduced to make interop with JS easier. Thanks to this, in order to type an object or module coming from JS we just need to declare an interface (as <a href="https://fable.io/ts2fable/">ts2fable</a> does) without any special syntax. On the other hand, this imposes some limitations: interface members cannot be overloaded and we cannot implement two or more interfaces when the member names conflict.</p>
<p>To overcome this limitations, Nagareyama introduces the <code>Mangle</code> attribute which can be used to decorate interfaces that won&#39;t be used to interop with JS and can safely be mangled, as you can see in this <a href="https://fable.io/repl3/#?code=PYBwpgdgBAygngZwC5gLYFgBQpJQGICGARgDZgB0AwsAE5hZYDaAPALIEQDmZAfALpYkccFABCBGgEkIKGgDMCAYzBQAvFiiaoxZDSVIxEgFxRdASy5QA7maQALKJzBIANKecatOpHsUGAIsAwwKjOdhacJnImABRyJMAEBgC0PFDxiSlpGUkAlFAAVFAAblEJSVCp6eVInprevgaSKKgmFllQinYS1rYOTq7utZha2kS6+lDNaCZdPVVEwMAkvfaOHiNe4z6TMACurVAsAAoSBKgAgjR6cPxQtmgIJuZcjHyVaS+cDJgsF9uNSgkAgIBD8QTCFTiGj-CZ+IEghAxAAeZUy+XUm00oVQRDANCgAH1yAA1AgkPYqVRQZF1KA4vEE4mBYKhewRFFuOAYmmFIpwOkNSYskJhCJoipVHLDCEiaEI0EojF0ix2fG2QwwgH6BVIgCMAAZyLk6WQDKg9khiGRedTaVioMBiviaGYACYqdkIcgitnhLhKtR00Zen1BUXsgPItyhskUsAmh3tfEKZSa6SyVMqGz2YNaBn4onkaGrfrOGI85HaCBuoYxblqXnMZJQAUO0YFgmh31igNyNzI5Xt0ZaM3pRtyGl5kdQMdV6mTgAs5AArNOR2O4BOoAB2cjrkPhb09yOcFGVVuJmfYtCMovTVCl9ZIGJmSvkRhmd4cWsIZz3TpGyrZsaXIAAVYBKG6GFrgIOAKygAAfNIrhuchUAIEAzCgOI9mgMwACZOiIqozEnbDqUIqB7FwRQoDAEg-2I-JkNgHwInXTt7xaJ8BhiRR3wgqCJFQuCENY0S4HIMBkTMZAEBwmJVHyATONvQtiX2VBXxaBAeUk8g6DdPY01w6Aqy3KoqwAal5Wyt3s-IHlQBAfjHFBkBwodRjHAg3TdY4KQQIiLKAqB7PCqACP3B0xwtEgkDMEASDgMCbDTUK7UKVtsrbHz-yICQiOpeVgUVAAiaFyvyIw0mhDMUyUegHUKmhosYA13hAgByAAtbq6Va6KSxAobix6WyxpPf0zz8gKgoItwAGZjXAoJ2IDcq8AI6rIrGxgCL4NaYA2s98lsmIEBAV0ZEncqAFIiEe8qoH27rRG6943uRT6ry0MaRpbAGJteoryC0mJyoIcq3HKohFBhqByrdarBrBktWOu9o5GgB6EBegB6AmoF6iQAE4VyWgA2cgd0XeRyT-BRGLAAhiEUeG2fh+H-J+DyX0TIA&html=DwCwLgtgNgfAUHUBTAhgE3gAm54ElgqbhgAOAtEgI4CuAlgG4C8A5AMID2AdmEj+QBUAnqSQtMAY268erXgA8wAenDQA3JJAoATgGcCTGmABm5ABwssOYLona6pMJl3aJTAEQB9TwAkA8gDKAt5KUHQARrpK2qgSYAB0pNocaDRxdNzxEHRc8QBWuu4wwEq29o5W2DZ2Dk4ubl6+gcGeoRFRMShx5GgcEInJqemZ2bkFRSVltZWYiFOOzq4eJKS6AFxKSjRcpADWAObxUhBKAAIA7kjhx6TcfGBRl9d9t1z3ugWnAEzxAAzxAGYlBIaLowH1KFAkPgeLpKLoAKzkdAoRxIbT5QrFUo1CpzXF1JbuFbrTbbPaHY5nJ43O6w4Gg8EQSHQ96nACM8R+vwZYIhSChMIeWRymImOPKYHg1UliwaJI2Wx2ByOfWpV1pb3pui0aCEvQgHPinKBOvQ+r6IrGWMmBPgCBKIFQGAd4RSQkkUBQul0HlRFCkPBQOXRRTgOFwECE5HCRnBXEwXvCAo8HA44qjMbj3GlSjdevtjsgsDgQA&css=BYFwtgNgNAUARgewCYE8AEBvGadoGYIB2IAtAM4CWAXgKYBcaAjAGwAOAHgNwwC+MMAOjABDCoRIBjIiFGEaAJ0zZcSCmVYRhKBngg0uynAHcKSEMAaMADFYCk3XGmA0KAc1CWb9w2gBWAVzIQCjwUSWkaYgYJSJAFB1xhCDdxCjiwMmjY+J9dfRJVeRoJYKJohAh-MEJuPkExVn8QJUdWYSRVQlcGAQAmAFYisAScAmJyanomNgNHEzMLNAGrDhG0EXlXMRJEEBAEMEsh2pggA">rather contrived example in the REPL</a>.</p>
<blockquote>
<p>Please note by default interface members will still NOT be mangled, so interop with JS won&#39;t break.</p>
</blockquote>
<p>In order to use the <code>Mangle</code> attribute you need to use a prerelease version of Fable.Core, though we are considering to publish the new Fable.Core as a minor release when Fable 3 is out as there are no breaking changes.</p>
<h2><a name="emit-js-helpers" class="anchor" href="#emit-js-helpers">Emit JS helpers</a></h2><p>There are two attributes Fable developers use often when interacting with JS code: <code>Import</code> and <code>Emit</code>. You can read more about them <a href="https://fable.io/docs/communicate/js-from-fable.html">here</a>.</p>
<p>In the case of the <code>Import</code> attribute, Fable.Core also provides function helpers to get a somewhat cleaner syntax.</p>
<pre><code class="language-fsharp"><span class="token keyword">open</span> Fable<span class="token punctuation">.</span>Core
<span class="token keyword">open</span> Fable<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>JsInterop

<span class="token comment">// Instead of...</span>
<span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">ImportMember</span><span class="token annotation-content"><span class="token punctuation">(</span><span class="token string">"my-module"</span><span class="token punctuation">)</span></span><span class="token punctuation">>]</span></span>
<span class="token keyword">let</span> <span class="token function">myFunction</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token class-name">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span> int <span class="token operator">=</span> jsNative

<span class="token comment">// We can do...</span>
<span class="token keyword">let</span> <span class="token function">myFunction</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token class-name">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span> int <span class="token operator">=</span> importMember <span class="token string">"my-module"</span>
</code></pre>
<p>In the case of emitting JS this was not balanced. Nagareyama resolves this by also including function helpers to emit JS raw strings, with the same <a href="https://fable.io/docs/communicate/js-from-fable.html#Emit-when-F-is-not-enough">replacement rules for arguments</a> as with the attributes. A big difference with the attributes is the code will be emitted in the declaring site instead of the call site.</p>
<pre><code class="language-fsharp"><span class="token keyword">let</span> measureTime <span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token class-name">unit <span class="token operator">-></span> unit</span><span class="token punctuation">)</span> <span class="token operator">=</span> emitJsStatement f <span class="token string">"""
   const startTime = process.hrtime();
   $0();
   const elapsed = process.hrtime(startTime);
   console.log("Ms:", elapsed[0] * 1e3 + elapsed[1] / 1e6);
"""</span>

<span class="token comment">// Note we can pass multiple arguments with a tuple</span>
<span class="token keyword">let</span> addAnything <span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token class-name">obj</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>y<span class="token punctuation">:</span> <span class="token class-name">obj</span><span class="token punctuation">)</span><span class="token punctuation">:</span> obj <span class="token operator">=</span> emitJsExpr <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token string">"$0 + $1"</span>
</code></pre>
<p>As usual, we don&#39;t recommend relying on inlined JS code too much, after all, Fable was developed to be able to use and advanced statically-typed language with the JS ecosystem, but sometime we just need to paste a piece of code we borrowed from the internet (we don&#39;t do that very often, but sometimes happens, right?) and the new helpers make this easier than using the attributes. </p>
<p>A word of caution about emitting <em>raw</em> javascript. Fable 2 relied on Babel to parse this raw code and integrate it with JS AST. Now Fable 3 prints this code directly, which surfaces a problem we don&#39;t have in F#: in JS as in other languages, there&#39;s a difference between &quot;expressions&quot; and &quot;statements&quot;. Fable 3 won&#39;t be able to tell them apart from a JS code string. That&#39;s why there are two helpers: <code>emitJsExpr</code> and <code>emitJsStatement</code>. The <code>Emit</code> attribute also includes now an optional <code>isStatement</code> parameter:</p>
<pre><code class="language-fsharp"><span class="token comment">// `debugger` can only appear in statement in JS</span>
<span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">Emit</span><span class="token annotation-content"><span class="token punctuation">(</span><span class="token string">"debugger"</span><span class="token punctuation">,</span> isStatement<span class="token operator">=</span><span class="token keyword">true</span><span class="token punctuation">)</span></span><span class="token punctuation">>]</span></span>
<span class="token keyword">let</span> <span class="token function">stopDebugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> unit <span class="token operator">=</span> jsNative
</code></pre>
<p>Again, while Fable 3 is prerelease you&#39;ll have to also download a prerelease version of Fable.Core in order to use the new Emit helpers.</p>
<br />

<p>We&#39;ve just published the (hopefully) latest release candidate. If you&#39;re already using Nagareyama please update to latest version and test that everything is fine. If there are no critical reports in the upcoming days, we will re-publish this as the official Fable 3 release! Exciting times ahead!</p>
</div></div><div class="column"></div></div></div></div><footer style="background-color:dodgerblue"><div class="content"><p>Fable <a href="https://github.com/fable-compiler/Fable">source code</a> is licensed <a href="http://opensource.org/licenses/mit-license.php">MIT</a>.</p></div></footer><script>
document.addEventListener('DOMContentLoaded', function () {
  // burger
  var $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  if ($navbarBurgers.length > 0) {
    $navbarBurgers.forEach(function ($el) {
      $el.addEventListener('click', function () {
        var target = $el.dataset.target;
        var $target = document.getElementById(target);
        $el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  }
});</script></body></html>