<html><head><title>Fable Blog</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="twitter:title" content="Fable"/><meta name="twitter:description" content="F# to JS compiler"/><meta name="twitter:image" content="https://fable.io/img/fable_logo.png"/><meta name="twitter:card" content="summary_large_image"/><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,300,600,700|Roboto+Mono|Fira+Code|Open+Sans:400,300,600,700"/><script src="https://kit.fontawesome.com/f1c8a90b9d.js"></script><link rel="stylesheet" type="text/css" href="/css/styles.css"/><link rel="stylesheet" type="text/css" href="/css/prism.css"/><link rel="shortcut icon" href="/img/fable.ico"/></head><body><nav class="navbar"><div class="navbar-brand"><a class="navbar-item is-size-4" href="/" style="background-color:rgba(0,0,0,0.5);color:dodgerblue;font-weight:600">Fable</a><div class="navbar-burger" data-target="navMenu"><span></span><span></span><span></span></div></div><div id="navMenu" class=" navbar-menu"><div class="navbar-start"><a class=" navbar-item" href="/docs">Docs</a><a class=" navbar-item is-active" href="/blog">Blog</a><a class=" navbar-item" href="/repl">REPL</a><a class=" navbar-item" href="/community">Community</a><a class=" navbar-item" href="/fableconf">FableConf</a></div><div class="navbar-end"><div class="field is-grouped"><a class="navbar-item" href="https://gitter.im/fable-compiler/Fable" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-gitter"></i></span></a><a class="navbar-item" href="https://github.com/fable-compiler/fable" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-github"></i></span></a><a class="navbar-item" href="https://twitter.com/FableCompiler" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-twitter"></i></span></a><a class="navbar-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-youtube"></i></span></a></div></div></div></nav><div class="markdown blog" style="overflow:hidden"><div class="fable-header-minimal"><figure class="image" style="max-width:200px;margin:20px auto"><img class="fable-logo" src="/img/fable_logo.png"/></figure></div><div style="margin-top:1.6rem"><div class="columns"><div class="column"></div><div class="column is-two-thirds"><div class="post_date" style="margin:5px;margin-bottom:2em"><i class=" far fa-calendar"></i> November 07, 2020</div><div class="content" style="margin:5px"><p>I hope you already tried out the new Fable and are enjoying it! If you haven&#39;t yet, please note the release candidate has just been published. This means we are focusing now on fixing bugs and there won&#39;t be any major change before the stable release. This is the perfect opportunity to try upgrading your app and check everything is working correctly (if it doesn&#39;t, <a href="https://github.com/fable-compiler/Fable/issues/new">let us know</a>). Be confident Nagareyama has already been tested in different production apps and we have already ironed out most (if not all) issues. To install Fable 3 just run the following command (use <code>update</code> instead of <code>install</code> if you already installed the tool previously):</p>
<pre><code>dotnet tool install fable --version &quot;3.0.0-nagareyama-*&quot;</code></pre><p>To upgrade an existing app using Webpack, check <a href="https://github.com/MangelMaxime/fulma-demo/pull/43">this guide as reference</a>.</p>
<p>In this post we will also dive into the differences when generating JS code compared to Fable 2.</p>
<h2><a name="the-good-news" class="anchor" href="#the-good-news">The good news</a></h2><p>The good news is Nagareyama aims to bring <strong>no code breaking changes</strong>. Besides the tooling updates described in the <a href="https://fable.io/blog/Announcing-Nagareyama-1.html">previous post</a>, your app should work as is when upgrading Fable!</p>
<p>However, it may happen your code relied on a specific and not documented implementation detail of Fable 2. In that case, please report to us to check if that is an actual regression or whether we can advise you how to adapt your code.</p>
<h2><a name="and-the-not-so-good-news" class="anchor" href="#and-the-not-so-good-news">And the not-so-good news</a></h2><p>As we saw in the previous post, the main change in Nagareyama is the removal of the Babel dependency. Unfortunately, one thing Babel did for us and we couldn&#39;t implement yet is the <a href="https://developer.mozilla.org/en-US/docs/Tools/Debugger/How_to/Use_a_source_map">source-maps</a> (which let you debug the F# code in the browser or in VS Code instead of the generated JS). If you relied on source-maps when programming with Fable, please help us <a href="https://github.com/fable-compiler/Fable/issues/2166">bring them back</a>.</p>
<h2><a name="better-name-mangling" class="anchor" href="#better-name-mangling">Better name-mangling</a></h2><p>To compensate the lack of source-maps, when implementing our own JS printers we&#39;ve also tried to make the generated JS code &quot;prettier&quot; so it&#39;s more readable and easier to debug directly. A very important point was the mangling of value names, necessary as in JS we cannot <em>shadow</em> values as we do in F#. Fable 2 was not very subtle here: firstly, it generated unique names <em>per file</em>, so functions arguments where mangled even if they didn&#39;t conflict in the local scope; and secondly, it used the <code>$</code> character (legal in JS but not in F# unless you use quotes) quite aggressively making the code more difficult to read. Nagareyama fixes this by using member scope instead and reducing the use of the dollar sign.</p>
<p>A simple example can be seen here. This is how Fable 2 compiled the following function:</p>
<pre><code class="language-fsharp"><span class="token keyword">let</span> map3 f xs ys zs <span class="token operator">=</span>
    fold3 <span class="token punctuation">(</span><span class="token keyword">fun</span> acc x y z <span class="token operator">-></span> f x y z<span class="token operator">::</span>acc<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> xs ys zs
    <span class="token operator">|></span> reverse</code></pre>
<pre><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mapIndexed3</span><span class="token punctuation">(</span><span class="token parameter">f$$<span class="token number">21</span><span class="token punctuation">,</span> xs$$<span class="token number">42</span><span class="token punctuation">,</span> ys$$<span class="token number">14</span><span class="token punctuation">,</span> zs$$<span class="token number">4</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> xs$$<span class="token number">43</span> <span class="token operator">=</span> <span class="token function">foldIndexed3</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">i$$<span class="token number">6</span><span class="token punctuation">,</span> acc$$<span class="token number">16</span><span class="token punctuation">,</span> x$$<span class="token number">22</span><span class="token punctuation">,</span> y$$<span class="token number">7</span><span class="token punctuation">,</span> z$$<span class="token number">3</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token punctuation">(</span><span class="token function">f$$21</span><span class="token punctuation">(</span>i$$<span class="token number">6</span><span class="token punctuation">,</span> x$$<span class="token number">22</span><span class="token punctuation">,</span> y$$<span class="token number">7</span><span class="token punctuation">,</span> z$$<span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acc$$<span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> xs$$<span class="token number">42</span><span class="token punctuation">,</span> ys$$<span class="token number">14</span><span class="token punctuation">,</span> zs$$<span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">reverse</span><span class="token punctuation">(</span>xs$$<span class="token number">43</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>The same function compiled with Nagareyama results in much cleaner code:</p>
<pre><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mapIndexed3</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> xs<span class="token punctuation">,</span> ys<span class="token punctuation">,</span> zs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> xs_1 <span class="token operator">=</span> <span class="token function">foldIndexed3</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> acc<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> xs<span class="token punctuation">,</span> ys<span class="token punctuation">,</span> zs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">reverse</span><span class="token punctuation">(</span>xs_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2><a name="js-classes" class="anchor" href="#js-classes">JS classes</a></h2><p>By default, Fable 2 used JS function constructors and prototype inheritance, though there was a compiler flag (rarely used) to generate ES2015 classes instead. In Fable 3 this is the default now (the only one option indeed), which makes the code more recognizable both to programmers (the C#-like class syntax is very extended) and to JS tooling.</p>
<p>Please note however, class members are still implemented as static functions (with a hash suffix to disambiguate overloads). This is the way F# actually compiles the code, and it also plays better with tree shaking and results in more perfomant code because JIT JS compilers can link the calls statically.</p>
<h2><a name="improvements-in-fable-library" class="anchor" href="#improvements-in-fable-library">Improvements in fable-library</a></h2><p>We&#39;ve made several improvements to the fable-library (containing the code Fable uses to replace calls to BCL/FSharp.Core). The biggest one being the inclusion of the new implementation of <a href="https://github.com/dotnet/fsharp/pull/10188">F# Map and Set in FSharp.Core</a> by Victor Baybekov. This brings a huge performance improvement to these immutable collections (they will be noticeably only if your app makes heavy use of Map and/or Set though). Fable&#39;s mysterious contributor, <a href="https://github.com/ncave">ncave</a>, is also working on a new implementation for immutable lists that hopefully can make it into Fable 3.0 or 3.1.</p>
<h2><a name="prevent-v8-deoptimizations" class="anchor" href="#prevent-v8-deoptimizations">Prevent V8 deoptimizations</a></h2><p>If you are somewhat familiar with how JS engines work and in particular V8, the most ubiquitous one, you probably know the JS performance-killers are deoptimizations: that is, when the engine makes an assumption about a function and generates optimized code for that, to later realize the function is being called in a different way than expected (we all know how many weird ways there are to run JS code).</p>
<p>There was already a big leap in the performance of the generated JS code when moving from Fable 1 to Fable 2, so this time there were not many obvious opportunities for optimization. However, ncave and <a href="https://github.com/chrisvanderpennen">Chris van der Pennen</a> have been working hard to identify the remaining ones, like stack traces in custom exceptions or getters in object literals, in order to fix them and make sure the JS code generated by Nagareyam doesn&#39;t include any performance pitfall.</p>
<br />

<p>That was all, folks. We are very close to the stable Fable 3 version so please help us identify the remaining issues by giving the release candidate a go. In the next posts we will review the actual new features in Nagareyama (not so many) and go into more detail about the speed improvements in the compiler itself.</p>
</div></div><div class="column"></div></div></div></div><footer style="background-color:dodgerblue"><div class="content"><p>Fable <a href="https://github.com/fable-compiler/Fable">source code</a> is licensed <a href="http://opensource.org/licenses/mit-license.php">MIT</a>.</p></div></footer><script>
document.addEventListener('DOMContentLoaded', function () {
  // burger
  var $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  if ($navbarBurgers.length > 0) {
    $navbarBurgers.forEach(function ($el) {
      $el.addEventListener('click', function () {
        var target = $el.dataset.target;
        var $target = document.getElementById(target);
        $el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  }
});</script></body></html>