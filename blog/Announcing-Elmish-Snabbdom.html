<html><head><title>Fable Blog</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="twitter:title" content="Fable"/><meta name="twitter:description" content="F# to JS compiler"/><meta name="twitter:image" content="https://fable.io/img/fable_logo.png"/><meta name="twitter:card" content="summary_large_image"/><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,300,600,700|Roboto+Mono|Fira+Code|Open+Sans:400,300,600,700"/><script src="https://kit.fontawesome.com/f1c8a90b9d.js"></script><link rel="stylesheet" type="text/css" href="/css/styles.css"/><link rel="stylesheet" type="text/css" href="/css/prism.css"/><link rel="shortcut icon" href="/img/fable.ico"/></head><body><nav class="navbar"><div class="navbar-brand"><a class="navbar-item is-size-4" href="/" style="background-color:rgba(0,0,0,0.5);color:dodgerblue;font-weight:600">Fable</a><div class="navbar-burger" data-target="navMenu"><span></span><span></span><span></span></div></div><div id="navMenu" class=" navbar-menu"><div class="navbar-start"><a class=" navbar-item" href="/docs">Docs</a><a class=" navbar-item is-active" href="/blog">Blog</a><a class=" navbar-item" href="/repl">REPL</a><a class=" navbar-item" href="/community">Community</a><a class=" navbar-item" href="/fableconf">FableConf</a></div><div class="navbar-end"><div class="field is-grouped"><a class="navbar-item" href="https://gitter.im/fable-compiler/Fable" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-gitter"></i></span></a><a class="navbar-item" href="https://github.com/fable-compiler/fable" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-github"></i></span></a><a class="navbar-item" href="https://twitter.com/FableCompiler" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-twitter"></i></span></a><a class="navbar-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-youtube"></i></span></a></div></div></div></nav><div class="markdown blog" style="overflow:hidden"><div class="fable-header-minimal"><figure class="image" style="max-width:200px;margin:20px auto"><img class="fable-logo" src="/img/fable_logo.png"/></figure></div><div style="margin-top:1.6rem"><div class="columns"><div class="column"></div><div class="column is-two-thirds"><div class="post_date" style="margin:5px;margin-bottom:2em"><i class=" far fa-calendar"></i> March 02, 2021</div><div class="content" style="margin:5px"><p>I&#39;ve been recently playing with <a href="https://github.com/alfonsogarciacaro/Feliz.Engine/tree/main/samples/Feliz.Snabbdom">Feliz.Engine</a>, an attempt to take advantage of the great work done by Zaid Ajaj and contributors with <a href="https://zaid-ajaj.github.io/Feliz/">Feliz</a> when writing non-React applications. As part of this I wanted to check how easy was to adapt Feliz.Engine to an alternative Virtual-DOM implementation, and I read good things about <a href="https://github.com/snabbdom/snabbdom">Snabbdom</a> so I gave it a go. This started just as an experiment but I&#39;ve been pleasantly surprised by how simple yet powerful Snabbdom is, and more importantly, how well it fits with the <a href="https://elmish.github.io/">Elmish architecture</a>, so I want to share with you my findings hoping that you find them useful.</p>
<p>There was recently a discussion in Twitter about the <a href="https://twitter.com/7sharp9_/status/1365270255170428928">problems with Fable Elmish</a>. So far, Elmish in Fable apps has always used React as the view engine, including React native for mobile (there are also Elmish implementations for non-Fable platforms like <a href="https://github.com/elmish/Elmish.WPF">WPF</a>, <a href="https://fsprojects.github.io/Fabulous/">Xamarin</a> or <a href="https://fsbolero.io/docs/Elmish">Blazor</a>), and there&#39;s been always friction between the concept of &quot;component&quot; in Elmish and React. This is a bit of technical discussion and I won&#39;t go into detail here, among other reasons because I&#39;ve never managed to explain the difference in an understandable manner. Probably the easiest is to consider Elm/Elmish don&#39;t really have a notion of &quot;component&quot; as Dave Thomas explains. It&#39;s true the Fable Elmish community tends to &quot;componentize&quot; apps maybe under the influence of React, which sometimes leads to an excess of boilerplate to wire everything.</p>
<p>It&#39;s possible to write an Elmish/React app with just a single view function, and some apps work well that way. But to take advantage of most of React features, like devtools, memoization or life-cycle events, you do need components, as React understands them. This is why some, myself guilty as charged, have been trying to drive towards more use of React components with Elmish. An important move for this has been the <a href="https://zaid-ajaj.github.io/Feliz/#/Hooks/UseElmish"><code>useElmish</code> React hook</a> which many Fable devs have successfully adopted. But at this point Elmish gets reduced to manage the internal state of your components and your app gets eventually architected the React-way. This is not a bad thing if you already know React, but this post is about &quot;rediscovering&quot; the power of Elmish as I&#39;ve been experiencing recently.</p>
<p>What if we try the other way around, that is, not worrying about &quot;componentizing&quot; our application? This is actually the original proposal of Elm/Elmish and what you get by using a low-level Virtual-DOM library like Snabbdom, instead of a full-fledged one like React. When I started trying to run Feliz.Engine with Snabbdom it was just about API ergonomics but being able to enjoy &quot;pure&quot; Elmish without giving up DOM control has been really freeing. Why I&#39;m excited about Snabbdom? These are some of the reasons for it:</p>
<h4><a name="it-39-s-just-functions-" class="anchor" href="#it-39-s-just-functions-">It&#39;s just functions!</a></h4><p>There&#39;s no concept of component that clashes with Elmish, just composable functions from beginning to end. Again, you ca do the same with React but as soon as you need to deal with the DOM or some other features you need the components. This is not the case of Snabbdom, keep reading.</p>
<h4><a name="css-transitions-built-in" class="anchor" href="#css-transitions-built-in">CSS transitions built in</a></h4><p>Easy CSS transitions was one of biggest <a href="https://svelte.dev/">Svelte</a> appeals for me, and I was very surprised to see Snabbdom has a similar mechanism. Together with the wonderful Feliz API (check <a href="https://github.com/alfonsogarciacaro/Feliz.Engine/blob/main/README.md">the differences</a> in Feliz.Engine), we can get a nice zoom-in/zoom-out effect just by attaching some styles to a node.</p>
<pre><code class="language-fsharp">Html<span class="token punctuation">.</span>li <span class="token punctuation">[</span>
    Attr<span class="token punctuation">.</span>className <span class="token string">"box"</span>

    Css<span class="token punctuation">.</span>opacity <span class="token number">0</span><span class="token punctuation">.</span>
    Css<span class="token punctuation">.</span>transformScale <span class="token number">1.5</span>
    <span class="token comment">// Snabbdom doesn't support `all`, we need to list all the transitioning properties</span>
    Css<span class="token punctuation">.</span><span class="token function">transitionProperty</span><span class="token punctuation">(</span>transitionProperty<span class="token punctuation">.</span>opacity<span class="token punctuation">,</span> transitionProperty<span class="token punctuation">.</span>transform<span class="token punctuation">)</span>
    Css<span class="token punctuation">.</span>transitionDurationSeconds <span class="token number">0.5</span>
    Css<span class="token punctuation">.</span>delayed <span class="token punctuation">[</span>
        Css<span class="token punctuation">.</span>opacity <span class="token number">1</span><span class="token punctuation">.</span>
        Css<span class="token punctuation">.</span>transformScale <span class="token number">1</span><span class="token punctuation">.</span>
    <span class="token punctuation">]</span>
    Css<span class="token punctuation">.</span>remove <span class="token punctuation">[</span>
        Css<span class="token punctuation">.</span>opacity <span class="token number">0</span><span class="token punctuation">.</span>
        Css<span class="token punctuation">.</span>transformScale <span class="token number">0.1</span>
    <span class="token punctuation">]</span></code></pre>
<p><img src="/img/blog/snabbdom-css-transitions.gif" alt="Snabbdom CSS transitions"></p>
<p>Learn more about Snabbdom CSS transitions <a href="https://github.com/snabbdom/snabbdom#delayed-properties">here</a>.</p>
<h4><a name="memoization" class="anchor" href="#memoization">Memoization</a></h4><p>In theory, given that a pure Elmish app fully recreates the whole virtual DOM for every tiny change it&#39;s important to be able to skip the parts of your app that don&#39;t need to change (in reality, this usually is not a performance issue thankfully). But memoization has been one of the biggest pain-points when writing Fable/React bindings (still is). Because of nuances of how JS/F# languages work and the way React expects you to declare a memoized component. a <a href="https://zaid-ajaj.github.io/Feliz/#/Feliz/React/CommonPitfalls">common pitfall</a> is to recreate the component for every function call rendering memoization useless. With Feliz.Snabbdom we just need to wrap a call with the <code>memoize</code> helper. For example, if we are displaying a list of Todos:</p>
<pre><code class="language-fsharp"><span class="token keyword">let</span> renderTodo dispatch <span class="token punctuation">(</span>todo<span class="token punctuation">:</span> <span class="token class-name">Todo</span><span class="token punctuation">,</span> editing<span class="token punctuation">:</span> <span class="token class-name">string</span> option<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">..</span><span class="token punctuation">.</span>

<span class="token keyword">let</span> renderTodoList <span class="token punctuation">(</span>state<span class="token punctuation">:</span> <span class="token class-name">State</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>dispatch<span class="token punctuation">:</span> <span class="token class-name">Msg <span class="token operator">-></span> unit</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    Html<span class="token punctuation">.</span>ul <span class="token punctuation">(</span>
        state<span class="token punctuation">.</span>TodoList <span class="token operator">|></span> List<span class="token punctuation">.</span>map <span class="token punctuation">(</span><span class="token keyword">fun</span> todo <span class="token operator">-></span>
            todo<span class="token punctuation">,</span>
            state<span class="token punctuation">.</span>Editing <span class="token operator">|></span> Option<span class="token punctuation">.</span>bind <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">if</span> i <span class="token operator">=</span> todo<span class="token punctuation">.</span>Id <span class="token keyword">then</span> Some e <span class="token keyword">else</span> None<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">|></span> List<span class="token punctuation">.</span>map <span class="token punctuation">(</span>renderTodo dispatch<span class="token punctuation">)</span>
    <span class="token punctuation">)</span></code></pre>
<p>We just need to wrap the <code>renderTodo</code> call (here also provide a way to get a unique id from the arguments). Note that we don&#39;t need to check <code>dispatch</code> for the memoization, so we can just partially apply it before the wrapping:</p>
<pre><code class="language-fsharp"><span class="token keyword">let</span> renderTodoList <span class="token punctuation">(</span>state<span class="token punctuation">:</span> <span class="token class-name">State</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>dispatch<span class="token punctuation">:</span> <span class="token class-name">Msg <span class="token operator">-></span> unit</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    Html<span class="token punctuation">.</span>ul <span class="token punctuation">(</span>
        state<span class="token punctuation">.</span>TodoList <span class="token operator">|></span> List<span class="token punctuation">.</span>map <span class="token punctuation">(</span><span class="token keyword">fun</span> todo <span class="token operator">-></span>
            todo<span class="token punctuation">,</span>
            state<span class="token punctuation">.</span>Editing <span class="token operator">|></span> Option<span class="token punctuation">.</span>bind <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">if</span> i <span class="token operator">=</span> todo<span class="token punctuation">.</span>Id <span class="token keyword">then</span> Some e <span class="token keyword">else</span> None<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">|></span> List<span class="token punctuation">.</span>map <span class="token punctuation">(</span>memoizeWithId <span class="token punctuation">(</span>renderTodo dispatch<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span>t<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">-></span> t<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span></code></pre>
<h4><a name="lifecycle-hooks" class="anchor" href="#lifecycle-hooks">Lifecycle hooks</a></h4><p>Unlike React ones, <a href="https://github.com/snabbdom/snabbdom#hooks">hooks in Snabbdom</a> are very easy to understand. They are just events fired at different points of the lifecycle of a virtual node, as when they get inserted into or removed from the actual DOM. Very conveniently, the virtual node holding a reference to the actual DOM element is passed as argument to the event handler so it&#39;s easy for example to get the actual height of an element.</p>
<p>React hooks allow you to do similar things, but they&#39;re designed in a way that forces you to translate your thinking into the React way of doing things. Let&#39;s say you want to turn some text into an input on double click, then select all the text and attach an event to the document so if you click outside the containing box you cancel the edit. For this, in React you need to (forgive me if there&#39;s a more clever way of doing this that I&#39;m missing):</p>
<ol>
<li>Make sure the function you are in is a component because this is required to use hooks.</li>
<li>Declare a reference to hold the actual input element with <code>useRef</code> hook (beware! you don&#39;t have the actual element yet).</li>
<li>Pass the value returned by <code>useRef</code> to a <code>ref</code> prop on the input element so React fills it.</li>
<li>Declare an effect with <code>useEffect</code> hook. Because you want the effect to happen when the input appears, you need to pass an array with a flag like <code>isEditable</code>.</li>
<li>The effect will happen when <code>isEditable</code> changes from false to true or from true to false, so make sure <code>isEditable</code> is true before running the effect.</li>
<li>Now get the input element from the value you declared in 2. Select the text and attach the event to the document body, return a disposable function to detach the event when <code>isEditable</code> changes to false.</li>
</ol>
<p>On the other hand, in Snabbdom if you want to, when an input element appears, select all the text, attach an event to the html body and detach it when the input disappears you need to:</p>
<ol>
<li>Add an <code>insert</code> hook to the input, so when it appears, you can select all the text, attach an event to the html body and return a disposable to detach it when the input disappears.</li>
</ol>
<p>Well, I&#39;m cheating a bit here, in &quot;raw&quot; Snabbdom keeping a reference to the disposable and disposing it when the element is destroyed is slightly more contrived, but luckily Feliz.Snabbdom provides an overload to <code>Hook.insert</code> so this is automatically done for you if the callback returns a disposable:</p>
<pre><code class="language-fsharp">Html<span class="token punctuation">.</span>input <span class="token punctuation">[</span>
    Attr<span class="token punctuation">.</span>classes <span class="token punctuation">[</span> <span class="token string">"input"</span><span class="token punctuation">;</span> <span class="token string">"is-medium"</span> <span class="token punctuation">]</span>
    Attr<span class="token punctuation">.</span>value editing
    Ev<span class="token punctuation">.</span>onTextChange <span class="token punctuation">(</span>SetEditedDescription <span class="token operator">>></span> dispatch<span class="token punctuation">)</span>
    onEnterOrEscape dispatch ApplyEdit CancelEdit

    Hook<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">fun</span> vnode <span class="token operator">-></span>
        <span class="token keyword">let</span> el <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">.</span>AsInputEl
        el<span class="token punctuation">.</span><span class="token keyword">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Select all text</span>

        <span class="token keyword">let</span> parentBox <span class="token operator">=</span> findParentWithClass <span class="token string">"box"</span> el
        <span class="token comment">// This function attachs the event to the body</span>
        <span class="token comment">// and returns a disposable to detach it</span>
        BodyEv<span class="token punctuation">.</span><span class="token function">onMouseDown</span><span class="token punctuation">(</span><span class="token keyword">fun</span> ev <span class="token operator">-></span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>parentBox<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>target <span class="token operator">:?></span> <span class="token class-name">_</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
                CancelEdit <span class="token operator">|></span> dispatch<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">]</span></code></pre>
<blockquote>
<p>Did you notice <code>BodyEv.onMouseDown</code>? This is another nice use-case of <a href="https://github.com/alfonsogarciacaro/Feliz.Engine/blob/cbf4b90de929d7202f941ef091436a8845634b80/src/Feliz.Snabbdom/Feliz.Snabbdom.fs#L163-L168">Feliz.Engine abstract classes</a>, it implements <code>EventEngine</code> by making it return a disposable.</p>
</blockquote>
<br />

<p>So Snabbdom is great, now what? Does this mean you need to ditch React for Fable apps? Of course not! React is still a great choice, with many useful tools and a gigantic ecosystem. It&#39;s true there are frictions with Elmish but thanks to the work of Zaid, Maxime Mangel and many others, together with the <code>ReactComponent</code> plugin in Fable 3 they&#39;ve become more bearable. So if you already know React quirks and/or rely on some of its tools and libraries you can be sure will still be well supported by Fable. Just if you&#39;re mainly interested in Elmish and don&#39;t really care for the underlying renderer you may want to give Elmish.Snabbdom a try if you&#39;re looking for less complexity. Clone the repo and try out <a href="https://github.com/alfonsogarciacaro/Feliz.Engine/tree/main/samples/Feliz.Snabbdom">this sample</a> to see how Elmish.Snabbdom can work for you.</p>
<p>And! If you are really into a purer Fable/F# experience and want more control of the DOM, take also a look at the awesome work of David Dawkins with <a href="https://davedawkins.github.io/Sutil">Sutil</a>!</p>
</div></div><div class="column"></div></div></div></div><footer style="background-color:dodgerblue"><div class="content"><p>Fable <a href="https://github.com/fable-compiler/Fable">source code</a> is licensed <a href="http://opensource.org/licenses/mit-license.php">MIT</a>.</p></div></footer><script>
document.addEventListener('DOMContentLoaded', function () {
  // burger
  var $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  if ($navbarBurgers.length > 0) {
    $navbarBurgers.forEach(function ($el) {
      $el.addEventListener('click', function () {
        var target = $el.dataset.target;
        var $target = document.getElementById(target);
        $el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  }
});</script></body></html>