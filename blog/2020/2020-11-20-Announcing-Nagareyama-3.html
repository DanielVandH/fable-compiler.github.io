<html class="has-navbar-fixed-top"><head><title>Fable</title><meta http-equiv="content-type"/><link rel="stylesheet" type="text/css" href="/style.css"/><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous"/></head><body><nav class="navbar is-fixed-top"><div class="container"><div class="navbar-brand"><a class="navbar-item title is-4" href="https://fable.io/">Fable</a><a class="navbar-item is-hidden-desktop" href="https://github.com/fable-compiler/fable"><span class="icon"><i class=" fab fa-github fa-lg"></i></span></a><a class="navbar-item is-hidden-desktop" href="https://twitter.com/FableCompiler"><span class="icon"><i class=" fab fa-twitter fa-lg"></i></span></a><a class="navbar-item is-hidden-desktop" href="https://gitter.im/fable-compiler/Fable"><span class="icon"><i class=" fab fa-gitter fa-lg"></i></span></a><a class="navbar-item is-hidden-desktop" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos"><span class="icon"><i class=" fab fa-youtube fa-lg"></i></span></a><a class="navbar-burger" data-target="nav-menu"><span></span><span></span><span></span></a></div><div class="navbar-menu" id="nav-menu"><div class="navbar-start"><a class="navbar-item" href="/documentation">Documentation</a><a class="navbar-item" href="https://fable.io/repl/">Try</a><a class="navbar-item is-active" href="/blog/index.html">Blog</a><a class="navbar-item" href="/community.html">Community</a><a class="navbar-item" href="/resources.html">Resources</a></div><div class="navbar-end"><a class="navbar-item" href="https://github.com/fable-compiler/fable"><span class="icon"><i class=" fab fa-github fa-lg"></i></span></a><a class="navbar-item" href="https://twitter.com/FableCompiler"><span class="icon"><i class=" fab fa-twitter fa-lg"></i></span></a><a class="navbar-item" href="https://gitter.im/fable-compiler/Fable"><span class="icon"><i class=" fab fa-gitter fa-lg"></i></span></a><a class="navbar-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos"><span class="icon"><i class=" fab fa-youtube fa-lg"></i></span></a></div></div></div></nav><div class="container"><div class="columns"><div class="column is-8-desktop is-offset-2-desktop"><div class="section blog-post"><figure class="image is-96x96 author-image"><img class="is-rounded" src="https://github.com/alfonsogarciacaro.png"/></figure><h2 class="title is-size-3 has-text-primary has-text-weight-normal has-text-centered blog-title">Announcing Nagareyama (Fable 3) (III)</h2><div class="tags has-addons is-justify-content-center"><a class="tag is-rounded is-medium is-primary" href="https://twitter.com/alfonsogcnunez">Alfonso Garc√≠a-Caro</a><span class="tag is-rounded is-medium">November 20, 2020</span></div><div class="content"><p>This is the third post in the &quot;Announcing Nagareyama (Fable 3)&quot; series. You can check the previous articles below:</p>
<ul>
<li><a href="https://fable.io/blog/Announcing-Nagareyama-1.html">Announcing Nagareyama I: Tooling</a></li>
<li><a href="https://fable.io/blog/Announcing-Nagareyama-2.html">Announcing Nagareyama II: Code Generation</a></li>
</ul>
<p>This time we will be focusing on the actual new features of Nagareyama. There are not so many because we've been focusing on the tooling improvements for this release, but there are still a couple of interesting surprises so let's go through them together!</p>
<h2>Plugins! <a href="#Plugins!" aria-hidden="true"><span class="anchor" id="Plugins!"></span>#</a></h2>
<p>Plugins are probably the most important new feature in Fable 3 but they're actually a comeback: Fable 1 already supported them. Unfortunately, their design was not good and only a few users could take some advantage of them. Because of this, plugins were removed during the Fable 2 rewrite. We hope the design issues have been fixed and we are confident plugins are going to be much more useful to Fable developers.</p>
<p>Why does Fable need plugins? Because one of Fable's goals is to interop well with JS code and tooling. Sometimes, JS tooling expects code to be written in a particular way that differs to the code generated by Fable. This poses a dilemma when developing the compiler: Do we change the code generation to fit this particular tool? Or do we add some magic for the specific use case, likely complicating things both for Fable maintainers and users? Or do we try to resolve the problem with code even if it results in non-idiomatic F# or conflicts with the type-checker?</p>
<p>Plugins are a way to solve this dilemma: we can add some magic to manipulate the generated code for this specific case, while keeping the Fable codebase cleaner. The most obvious example and the first plugin of the Nagareyama-gen are React components. On first sight, <a href="https://en.reactjs.org/docs/components-and-props.html#function-and-class-components">React function components</a> look very similar to F# code. I will spare you of the details (you can have a look at this <a href="https://github.com/fable-compiler/fable-react/pull/188">long discussion</a> if interested) but there are actually many nuances that have caused many problems. Last week at .NET Conf, <a href="https://twitter.com/zaid_ajaj">Zaid Ajaj</a> presented a new way of creating React components simply by decorating a function with an attribute using Nagareyama plugins, as in:</p>
<pre style="background-color: #FFFFFF;color: #000000;padding: 1em"><code><span style="color: #0184BC">[&lt;ReactComponent&gt;]</span>
<span style="color: #A626A4">let</span><span> </span><span style="color: #E45649">counter</span><span style="color: #986801">()</span><span> </span><span style="color: #A626A4">=</span>
<span>    </span><span style="color: #A626A4">let</span><span> </span><span style="color: #A626A4">(</span><span style="color: #383A42">count</span><span style="color: #A626A4">,</span><span> </span><span style="color: #383A42">setCount</span><span style="color: #A626A4">)</span><span> </span><span style="color: #A626A4">=</span><span> React.useState</span><span style="color: #A626A4">(</span><span style="color: #986801">0</span><span style="color: #A626A4">)</span>
<span>    Html.div </span><span style="color: #A626A4">[</span>
<span>        prop.style </span><span style="color: #A626A4">[</span><span> style.padding </span><span style="color: #986801">20</span><span> </span><span style="color: #A626A4">]</span>
<span>        prop.children </span><span style="color: #A626A4">[</span>
<span>            Html.h1 count</span>
<span>            Html.button </span><span style="color: #A626A4">[</span>
<span>                prop.text </span><span style="color: #50A14F">&quot;Increment&quot;</span>
<span>                prop.onClick </span><span style="color: #A626A4">(fun</span><span style="color: #383A42"> _ </span><span style="color: #A626A4">-&gt;</span><span> setCount</span><span style="color: #A626A4">(</span><span>count </span><span style="color: #A626A4">+</span><span> </span><span style="color: #986801">1</span><span style="color: #A626A4">))</span>
<span>            </span><span style="color: #A626A4">]</span>
<span>        </span><span style="color: #A626A4">]</span>
<span>    </span><span style="color: #A626A4">]</span></code></pre>
<p>If you haven't <a href="https://www.youtube.com/watch?v=a6Ct3CM_lj4">watched his presentation yet</a>, please do it. It's a great introduction to creating React apps using F# and <a href="https://zaid-ajaj.github.io/Feliz/">Feliz</a> and Zaid is an awesome presenter!</p>
<h2>Witnesses <a href="#Witnesses" aria-hidden="true"><span class="anchor" id="Witnesses"></span>#</a></h2>
<p>It may be a hard-sell to promote this as a new feature, as it is something &quot;hidden&quot; int the F# compiler and you probably won't notice it all in your Fable code. It is however, one of the biggest improvements in Fable 3 and it has to do with <a href="https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/generics/statically-resolved-type-parameters">SRTP</a> resolution. So far, SRTP were resolved internally by the F# compiler in an opaque way, and because of this Fable and other F#-to-X compilers had to do their own resolution, rendering different results in some situations. Don Syme has been working a lot to change this and now, thanks to the witnesses the F# compiler exposes the information necessary to make sure Fable resolves SRTP in the same way F# does and avoiding compilation errors because of the use of advanced patterns. You can read more about <a href="https://github.com/fsharp/fslang-design/blob/master/FSharp-5.0/FS-1071-witness-passing-quotations.md">witnesses in F# here</a>.</p>
<h2>Mangle interfaces <a href="#Mangle-interfaces" aria-hidden="true"><span class="anchor" id="Mangle-interfaces"></span>#</a></h2>
<p>If you've read the documentation about <a href="https://fable.io/docs/communicate/fable-from-js.html#Name-mangling">calling Fable code from JS</a> or inspected the generated JS code, you'll know that Fable detaches and mangles instance members. This is necessary for several reasons like overload resolution or tree shaking. But an exception, interface members, was introduced to make interop with JS easier. Thanks to this, in order to type an object or module coming from JS we just need to declare an interface (as <a href="https://fable.io/ts2fable/">ts2fable</a> does) without any special syntax. On the other hand, this imposes some limitations: interface members cannot be overloaded and we cannot implement two or more interfaces when the member names conflict.</p>
<p>To overcome this limitations, Nagareyama introduces the <code>Mangle</code> attribute which can be used to decorate interfaces that won't be used to interop with JS and can safely be mangled, as you can see in this <a href="https://fable.io/repl3/#?code=PYBwpgdgBAygngZwC5gLYFgBQpJQGICGARgDZgB0AwsAE5hZYDaAPALIEQDmZAfALpYkccFABCBGgEkIKGgDMCAYzBQAvFiiaoxZDSVIxEgFxRdASy5QA7maQALKJzBIANKecatOpHsUGAIsAwwKjOdhacJnImABRyJMAEBgC0PFDxiSlpGUkAlFAAVFAAblEJSVCp6eVInprevgaSKKgmFllQinYS1rYOTq7utZha2kS6+lDNaCZdPVVEwMAkvfaOHiNe4z6TMACurVAsAAoSBKgAgjR6cPxQtmgIJuZcjHyVaS+cDJgsF9uNSgkAgIBD8QTCFTiGj-CZ+IEghAxAAeZUy+XUm00oVQRDANCgAH1yAA1AgkPYqVRQZF1KA4vEE4mBYKhewRFFuOAYmmFIpwOkNSYskJhCJoipVHLDCEiaEI0EojF0ix2fG2QwwgH6BVIgCMAAZyLk6WQDKg9khiGRedTaVioMBiviaGYACYqdkIcgitnhLhKtR00Zen1BUXsgPItyhskUsAmh3tfEKZSa6SyVMqGz2YNaBn4onkaGrfrOGI85HaCBuoYxblqXnMZJQAUO0YFgmh31igNyNzI5Xt0ZaM3pRtyGl5kdQMdV6mTgAs5AArNOR2O4BOoAB2cjrkPhb09yOcFGVVuJmfYtCMovTVCl9ZIGJmSvkRhmd4cWsIZz3TpGyrZsaXIAAVYBKG6GFrgIOAKygAAfNIrhuchUAIEAzCgOI9mgMwACZOiIqozEnbDqUIqB7FwRQoDAEg-2I-JkNgHwInXTt7xaJ8BhiRR3wgqCJFQuCENY0S4HIMBkTMZAEBwmJVHyATONvQtiX2VBXxaBAeUk8g6DdPY01w6Aqy3KoqwAal5Wyt3s-IHlQBAfjHFBkBwodRjHAg3TdY4KQQIiLKAqB7PCqACP3B0xwtEgkDMEASDgMCbDTUK7UKVtsrbHz-yICQiOpeVgUVAAiaFyvyIw0mhDMUyUegHUKmhosYA13hAgByAAtbq6Va6KSxAobix6WyxpPf0zz8gKgoItwAGZjXAoJ2IDcq8AI6rIrGxgCL4NaYA2s98lsmIEBAV0ZEncqAFIiEe8qoH27rRG6943uRT6ry0MaRpbAGJteoryC0mJyoIcq3HKohFBhqByrdarBrBktWOu9o5GgB6EBegB6AmoF6iQAE4VyWgA2cgd0XeRyT-BRGLAAhiEUeG2fh+H-J+DyX0TIA&amp;html=DwCwLgtgNgfAUHUBTAhgE3gAm54ElgqbhgAOAtEgI4CuAlgG4C8A5AMID2AdmEj+QBUAnqSQtMAY268erXgA8wAenDQA3JJAoATgGcCTGmABm5ABwssOYLona6pMJl3aJTAEQB9TwAkA8gDKAt5KUHQARrpK2qgSYAB0pNocaDRxdNzxEHRc8QBWuu4wwEq29o5W2DZ2Dk4ubl6+gcGeoRFRMShx5GgcEInJqemZ2bkFRSVltZWYiFOOzq4eJKS6AFxKSjRcpADWAObxUhBKAAIA7kjhx6TcfGBRl9d9t1z3ugWnAEzxAAzxAGYlBIaLowH1KFAkPgeLpKLoAKzkdAoRxIbT5QrFUo1CpzXF1JbuFbrTbbPaHY5nJ43O6w4Gg8EQSHQ96nACM8R+vwZYIhSChMIeWRymImOPKYHg1UliwaJI2Wx2ByOfWpV1pb3pui0aCEvQgHPinKBOvQ+r6IrGWMmBPgCBKIFQGAd4RSQkkUBQul0HlRFCkPBQOXRRTgOFwECE5HCRnBXEwXvCAo8HA44qjMbj3GlSjdevtjsgsDgQA&amp;css=BYFwtgNgNAUARgewCYE8AEBvGadoGYIB2IAtAM4CWAXgKYBcaAjAGwAOAHgNwwC+MMAOjABDCoRIBjIiFGEaAJ0zZcSCmVYRhKBngg0uynAHcKSEMAaMADFYCk3XGmA0KAc1CWb9w2gBWAVzIQCjwUSWkaYgYJSJAFB1xhCDdxCjiwMmjY+J9dfRJVeRoJYKJohAh-MEJuPkExVn8QJUdWYSRVQlcGAQAmAFYisAScAmJyanomNgNHEzMLNAGrDhG0EXlXMRJEEBAEMEsh2pggA">rather contrived example in the REPL</a>.</p>
<blockquote>
<p>Please note by default interface members will still NOT be mangled, so interop with JS won't break.</p>
</blockquote>
<p>In order to use the <code>Mangle</code> attribute you need to use a prerelease version of Fable.Core, though we are considering to publish the new Fable.Core as a minor release when Fable 3 is out as there are no breaking changes.</p>
<h2>Emit JS helpers <a href="#Emit-JS-helpers" aria-hidden="true"><span class="anchor" id="Emit-JS-helpers"></span>#</a></h2>
<p>There are two attributes Fable developers use often when interacting with JS code: <code>Import</code> and <code>Emit</code>. You can read more about them <a href="https://fable.io/docs/communicate/js-from-fable.html">here</a>.</p>
<p>In the case of the <code>Import</code> attribute, Fable.Core also provides function helpers to get a somewhat cleaner syntax.</p>
<pre style="background-color: #FFFFFF;color: #000000;padding: 1em"><code><span style="color: #A626A4">open</span><span> </span><span style="color: #4078F2">Fable.Core</span>
<span style="color: #A626A4">open</span><span> </span><span style="color: #4078F2">Fable.Core.JsInterop</span>

<span style="color: #A0A1A7;font-style: italic">// Instead of...</span>
<span style="color: #0184BC">[&lt;ImportMember</span><span style="color: #A626A4">(</span><span style="color: #50A14F">&quot;my-module&quot;</span><span style="color: #A626A4">)</span><span style="color: #0184BC">&gt;]</span>
<span style="color: #A626A4">let</span><span> </span><span style="color: #E45649">myFunction</span><span style="color: #A626A4">(</span><span style="color: #383A42">x</span><span style="color: #A626A4">:</span><span> </span><span style="color: #C18401">int</span><span style="color: #A626A4">):</span><span> </span><span style="color: #C18401">int </span><span style="color: #A626A4">=</span><span> jsNative</span>

<span style="color: #A0A1A7;font-style: italic">// We can do...</span>
<span style="color: #A626A4">let</span><span> </span><span style="color: #E45649">myFunction</span><span style="color: #A626A4">(</span><span style="color: #383A42">x</span><span style="color: #A626A4">:</span><span> </span><span style="color: #C18401">int</span><span style="color: #A626A4">):</span><span> </span><span style="color: #C18401">int </span><span style="color: #A626A4">=</span><span> importMember </span><span style="color: #50A14F">&quot;my-module&quot;</span></code></pre>
<p>In the case of emitting JS this was not balanced. Nagareyama resolves this by also including function helpers to emit JS raw strings, with the same <a href="https://fable.io/docs/communicate/js-from-fable.html#Emit-when-F-is-not-enough">replacement rules for arguments</a> as with the attributes. A big difference with the attributes is the code will be emitted in the declaring site instead of the call site.</p>
<pre style="background-color: #FFFFFF;color: #000000;padding: 1em"><code><span style="color: #A626A4">let</span><span> </span><span style="color: #E45649">measureTime</span><span style="color: #383A42"> </span><span style="color: #A626A4">(</span><span style="color: #383A42">f</span><span style="color: #A626A4">:</span><span> </span><span style="color: #C18401">unit </span><span style="color: #A626A4">-&gt;</span><span> </span><span style="color: #C18401">unit</span><span style="color: #A626A4">)</span><span> </span><span style="color: #A626A4">=</span><span> emitJsStatement f </span><span style="color: #50A14F">&quot;&quot;&quot;</span>
<span style="color: #50A14F">   const startTime = process.hrtime();</span>
<span style="color: #50A14F">   $0();</span>
<span style="color: #50A14F">   const elapsed = process.hrtime(startTime);</span>
<span style="color: #50A14F">   console.log(&quot;Ms:&quot;, elapsed[0] * 1e3 + elapsed[1] / 1e6);</span>
<span style="color: #50A14F">&quot;&quot;&quot;</span>

<span style="color: #A0A1A7;font-style: italic">// Note we can pass multiple arguments with a tuple</span>
<span style="color: #A626A4">let</span><span> </span><span style="color: #E45649">addAnything</span><span style="color: #383A42"> </span><span style="color: #A626A4">(</span><span style="color: #383A42">x</span><span style="color: #A626A4">:</span><span> </span><span style="color: #C18401">obj</span><span style="color: #A626A4">)</span><span> </span><span style="color: #A626A4">(</span><span style="color: #383A42">y</span><span style="color: #A626A4">:</span><span> </span><span style="color: #C18401">obj</span><span style="color: #A626A4">):</span><span> </span><span style="color: #C18401">obj </span><span style="color: #A626A4">=</span><span> emitJsExpr </span><span style="color: #A626A4">(</span><span>x</span><span style="color: #A626A4">,</span><span> y</span><span style="color: #A626A4">)</span><span> </span><span style="color: #50A14F">&quot;$0 + $1&quot;</span></code></pre>
<p>As usual, we don't recommend relying on inlined JS code too much, after all, Fable was developed to be able to use and advanced statically-typed language with the JS ecosystem, but sometime we just need to paste a piece of code we borrowed from the internet (we don't do that very often, but sometimes happens, right?) and the new helpers make this easier than using the attributes.</p>
<p>A word of caution about emitting <em>raw</em> javascript. Fable 2 relied on Babel to parse this raw code and integrate it with JS AST. Now Fable 3 prints this code directly, which surfaces a problem we don't have in F#: in JS as in other languages, there's a difference between &quot;expressions&quot; and &quot;statements&quot;. Fable 3 won't be able to tell them apart from a JS code string. That's why there are two helpers: <code>emitJsExpr</code> and <code>emitJsStatement</code>. The <code>Emit</code> attribute also includes now an optional <code>isStatement</code> parameter:</p>
<pre style="background-color: #FFFFFF;color: #000000;padding: 1em"><code><span style="color: #A0A1A7;font-style: italic">// `debugger` can only appear in statement in JS</span>
<span style="color: #0184BC">[&lt;Emit</span><span style="color: #A626A4">(</span><span style="color: #50A14F">&quot;debugger&quot;</span><span style="color: #A626A4">,</span><span style="color: #0184BC"> isStatement</span><span style="color: #A626A4">=</span><span style="color: #986801">true</span><span style="color: #A626A4">)</span><span style="color: #0184BC">&gt;]</span>
<span style="color: #A626A4">let</span><span> </span><span style="color: #E45649">stopDebugger</span><span style="color: #986801">()</span><span style="color: #A626A4">:</span><span> </span><span style="color: #C18401">unit </span><span style="color: #A626A4">=</span><span> jsNative</span></code></pre>
<p>Again, while Fable 3 is prerelease you'll have to also download a prerelease version of Fable.Core in order to use the new Emit helpers.</p>
<br />
<p>We've just published the (hopefully) latest release candidate. If you're already using Nagareyama please update to latest version and test that everything is fine. If there are no critical reports in the upcoming days, we will re-publish this as the official Fable 3 release! Exciting times ahead!</p>
</div></div></div><script src="/static/nacara_internals/menu.js"></script></div></div><script async="" src="/resources/nacara-standard-layouts/scripts/menu.js"></script></body></html>