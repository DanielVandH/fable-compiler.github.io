<html><head><title>Fable Blog</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="twitter:title" content="Fable"/><meta name="twitter:description" content="F# to JS compiler"/><meta name="twitter:image" content="https://fable.io/img/fable_logo.png"/><meta name="twitter:card" content="summary_large_image"/><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,300,600,700|Roboto+Mono|Fira+Code|Open+Sans:400,300,600,700"/><script src="https://kit.fontawesome.com/f1c8a90b9d.js"></script><link rel="stylesheet" type="text/css" href="/css/styles.css"/><link rel="stylesheet" type="text/css" href="/css/prism.css"/><link rel="shortcut icon" href="/img/fable.ico"/></head><body><nav class="navbar"><div class="navbar-brand"><a class="navbar-item is-size-4" href="/" style="background-color:rgba(0,0,0,0.5);color:dodgerblue;font-weight:600">Fable</a><div class="navbar-burger" data-target="navMenu"><span></span><span></span><span></span></div></div><div id="navMenu" class=" navbar-menu"><div class="navbar-start"><a class=" navbar-item" href="/docs">Docs</a><a class=" navbar-item is-active" href="/blog">Blog</a><a class=" navbar-item" href="/repl">REPL</a><a class=" navbar-item" href="/community">Community</a><a class=" navbar-item" href="/fableconf">FableConf</a></div><div class="navbar-end"><div class="field is-grouped"><a class="navbar-item" href="https://gitter.im/fable-compiler/Fable" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-gitter"></i></span></a><a class="navbar-item" href="https://github.com/fable-compiler/fable" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-github"></i></span></a><a class="navbar-item" href="https://twitter.com/FableCompiler" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-twitter"></i></span></a><a class="navbar-item" href="https://www.youtube.com/channel/UC6m70Jyr65ogDySbK7aMmzg/videos" target="_blank" style="color:white"><span class="icon"><i class=" fab fa-youtube"></i></span></a></div></div></div></nav><div class="markdown blog" style="overflow:hidden"><div class="fable-header-minimal"><figure class="image" style="max-width:200px;margin:20px auto"><img class="fable-logo" src="/img/fable_logo.png"/></figure></div><div style="margin-top:1.6rem"><div class="columns"><div class="column"></div><div class="column is-two-thirds"><div class="post_date" style="margin:5px;margin-bottom:2em"><i class=" far fa-calendar"></i> April 16, 2019</div><div class="content" style="margin:5px"><p>Fable.React 5 has just been released with new additions to help write your Fable/Elmish apps with React. Before going into detail, I want to thank Julien Roncaglia (@vbfox) who has contributed most of the ideas for this release since <a href="https://www.youtube.com/watch?v=9VJoaNoutm4">his talk at latest FableConf</a>, as well as the React team for their great work in the latest releases. And also to Don Syme and the other F# compiler contributors who have added features like anonymous records to make F# even more suitable to write UIs!</p>
<blockquote>
<p>Note this release depends on Fable.Core 3 and Fable.Browser.Dom, please <a href="https://fable.io/blog/Announcing-2-2.html">read the previous post</a> to learn about the changes in the ecosystem.</p>
</blockquote>
<p>So far, in Elmish applications the most common way to render the UI was to use simple functions, which is great and shows the power of Functional Programming for building UIs. However, in order to use React features like keeping internal state or getting a reference to the actual element in the browser&#39;s DOM, we had to declare a full class component. It worked, but required quite a bit of code to turn the view functions into classes and override the proper methods.</p>
<p>This is about to end since React 16.8 and the introduction of <a href="https://reactjs.org/docs/hooks-overview.html">hooks</a> which gives function components the same possibilities as class components have. Fable.React 5 focus on this and, in fact, from now on it may be difficult to tell functions from function components apart, so let&#39;s learn more about what distinguishes them.</p>
<h2><a name="functions-vs-function-components" class="anchor" href="#functions-vs-function-components">Functions vs Function Components</a></h2><p>Functions are <strong>just functions</strong> (I&#39;m also in a position to confirm water is wet): each time you call them, their code is run, you get a value in return and forget about them.</p>
<pre><code class="language-fsharp"><span class="token keyword">open</span> Fable<span class="token punctuation">.</span>React

<span class="token keyword">let</span> myView <span class="token punctuation">(</span>props<span class="token punctuation">:</span> <span class="token class-name">MyProps</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    div <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>str props<span class="token punctuation">.</span>message<span class="token punctuation">]</span>

<span class="token comment">// We could just replace the call to myView with</span>
<span class="token comment">// the body of the function and get the same result</span>
<span class="token keyword">let</span> rootView msg <span class="token operator">=</span>
    <span class="token computation-expression keyword">myView</span> <span class="token punctuation">{</span> message <span class="token operator">=</span> msg <span class="token punctuation">}</span>
</code></pre>
<p>On the other hand, function components are <strong>actual entities</strong> in the Virtual DOM, which means you can visualize them in the React dev tools or include triggers for different moments of the component&#39;s life cycle. In Fable.React 5 we use the <code>FunctionComponent</code> helper to declare them. The signature is the same as that of a function <code>&#39;Props -&gt; ReactElement</code> so, as a convention, we will use <strong>upper case to name them</strong> and highlight them over simple functions.</p>
<pre><code class="language-fsharp"><span class="token keyword">let</span> MyView <span class="token operator">=</span>
    FunctionComponent<span class="token punctuation">.</span><span class="token function">Of</span><span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span>props<span class="token punctuation">:</span> <span class="token class-name">Props</span><span class="token punctuation">)</span> <span class="token operator">-></span>
        div <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>str props<span class="token punctuation">.</span>message<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> rootView msg <span class="token operator">=</span>
    <span class="token computation-expression keyword">MyView</span> <span class="token punctuation">{</span> message <span class="token operator">=</span> msg <span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>This distinction is not exactly the same in React, because React apps usually use JSX for the UI code so the difference radicates in <em>the way you call the function</em>. Because Fable apps just use F#, we need the <code>FunctionComponent</code> wrapper to get the desired behavior.</p>
</blockquote>
<p>When to use a function component? Whenever you need:</p>
<ul>
<li>To <strong>skip rendering</strong> the component if the props haven&#39;t changed. This is specially important when using central state management like Elmish, because every time our UI model is updated a new render for the whole app will be triggered. Skip the parts of the UI tree that don&#39;t need to change with the <code>memoizeWith</code> parameter, which receives a function to check if the old and new props are equal. Fable.React 5 also provides the <code>equalsButFunctions</code> helper which doesn&#39;t take into account the functions in the props object (useful in Elmish apps where we usually pass the <code>dispatch</code> function down the UI tree).</li>
</ul>
<pre><code class="language-fsharp"><span class="token keyword">let</span> MyView  <span class="token operator">=</span>
    FunctionComponent<span class="token punctuation">.</span><span class="token function">Of</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">fun</span> p <span class="token operator">-></span> <span class="token operator">..</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memoizeWith <span class="token operator">=</span> equalsButFunctions<span class="token punctuation">)</span>
</code></pre>
<ul>
<li><p>To keep some <strong>internal state</strong> for the component, which can be done using React&#39;s state hook. Hooks also give you more capabilities concerning the component&#39;s life cycle. Read more about them in the next section.</p>
</li>
<li><p>To <strong>visualize the component</strong> in React dev tools, very helpful for debugging. Use the <code>displayName</code> parameter to set a custom name for the component in React dev tools.</p>
</li>
</ul>
<h2><a name="react-hooks" class="anchor" href="#react-hooks">React Hooks</a></h2><p>In Elmish apps we keep a central model for our whole app so most of the times we don&#39;t need stateful React components.</p>
<pre><code class="language-fsharp"><span class="token keyword">let</span> view <span class="token punctuation">(</span>props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">|</span> count<span class="token punctuation">:</span> <span class="token class-name">int</span><span class="token punctuation">;</span> dispatch<span class="token punctuation">:</span> <span class="token class-name">int <span class="token operator">-></span> unit</span> <span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span>
      button
        <span class="token punctuation">[</span> OnClick <span class="token punctuation">(</span><span class="token keyword">fun</span> _ <span class="token operator">-></span> props<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">|></span> props<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span> <span class="token punctuation">]</span>
        <span class="token punctuation">[</span> str <span class="token string">"Times clicked: "</span><span class="token punctuation">;</span> ofInt props<span class="token punctuation">.</span>count <span class="token punctuation">]</span>
</code></pre>
<p>In some occasions however we don&#39;t want to include some very specific internal state in the global model (e.g. whether a dropdown is open or closed), and in order to do that we need to deploy a full class. The example above would become:</p>
<pre><code class="language-fsharp"><span class="token keyword">type</span> <span class="token class-name">Props</span> <span class="token operator">=</span> <span class="token punctuation">{</span> initCount<span class="token punctuation">:</span> <span class="token class-name">int</span> <span class="token punctuation">}</span>
<span class="token keyword">type</span> <span class="token class-name">State</span> <span class="token operator">=</span> <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token class-name">int</span> <span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">MyView</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">inherit</span> <span class="token class-name">Component</span><span class="token operator">&lt;</span>Props<span class="token punctuation">,</span> State<span class="token operator">></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
    <span class="token keyword">do</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">setInitState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count <span class="token operator">=</span> props<span class="token punctuation">.</span>initCount <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> this<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
          button
            <span class="token punctuation">[</span> OnClick <span class="token punctuation">(</span><span class="token keyword">fun</span> _ <span class="token operator">-></span>
                this<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">fun</span> s _ <span class="token operator">-></span> <span class="token punctuation">{</span> s <span class="token keyword">with</span> count <span class="token operator">=</span> s<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>
            <span class="token punctuation">[</span> str <span class="token string">"Times clicked: "</span><span class="token punctuation">;</span> ofInt this<span class="token punctuation">.</span>state<span class="token punctuation">.</span>count <span class="token punctuation">]</span>
</code></pre>
<p>The situation gets more complicated when we also want to trigger some code at specific points in the life cycle, keep a reference to value outside the component state, etc. Thankfully, since React 16.8 we can use hooks to empower functions with all these capabilities. Now adding state to a component is as simple as:</p>
<pre><code class="language-fsharp"><span class="token keyword">let</span> view <span class="token operator">=</span>
    FunctionComponent<span class="token punctuation">.</span><span class="token function">Of</span><span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span>props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">|</span> initCount<span class="token punctuation">:</span> <span class="token class-name">int</span> <span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-></span>
    <span class="token keyword">let</span> state <span class="token operator">=</span> Hooks<span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>initCount<span class="token punctuation">)</span> <span class="token comment">// This is where the magic happens</span>
    button
        <span class="token punctuation">[</span> OnClick <span class="token punctuation">(</span><span class="token keyword">fun</span> _ <span class="token operator">-></span> state<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">fun</span> s <span class="token operator">-></span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>
        <span class="token punctuation">[</span> str <span class="token string">"Times clicked: "</span><span class="token punctuation">;</span> ofInt state<span class="token punctuation">.</span>current <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
</code></pre>
<p>I won&#39;t explain hooks in detail because <a href="https://reactjs.org/docs/hooks-overview.html">React documentation is already a fantastic source</a> for that. Fable.React 5 provides bindings for the most commonly used hooks (<code>useState</code>, <code>useEffect</code>, <code>useRef</code>, <code>useMemo</code>...) matching React&#39;s API for the most part, except for a few cases where a different name is necessary to comply with F# overloading rules. I will only show another example combining <code>useEffect</code> and <code>useRef</code> to detect a click <em>outside</em> our component, something that beforehand required quite a bit of code.</p>
<pre><code class="language-fsharp"><span class="token keyword">open</span> Browser<span class="token punctuation">.</span>Types

<span class="token keyword">let</span> attachEvent <span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token class-name">Event<span class="token operator">-></span>unit</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>node<span class="token punctuation">:</span> <span class="token class-name">Node</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>eventType<span class="token punctuation">:</span> <span class="token class-name">string</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
    <span class="token punctuation">{</span> <span class="token keyword">new</span> <span class="token class-name">System<span class="token punctuation">.</span>IDisposable</span> <span class="token keyword">with</span>
        <span class="token keyword">member</span> __<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">let</span> view <span class="token operator">=</span>
    FunctionComponent<span class="token punctuation">.</span><span class="token function">Of</span><span class="token punctuation">(</span><span class="token keyword">fun</span> props <span class="token operator">-></span>
        <span class="token comment">// Keep a value ref during component's life cycle, initialized to None</span>
        <span class="token keyword">let</span> selfRef <span class="token operator">=</span> Hooks<span class="token punctuation">.</span>useRef None

        <span class="token comment">// Passing an empty array for dependencies tells React the effect should</span>
        <span class="token comment">// only run when mounting (and the disposable when unmounting)</span>
        Hooks<span class="token punctuation">.</span><span class="token function">useEffectDisposable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span>
            <span class="token punctuation">(</span>Browser<span class="token punctuation">.</span>Dom<span class="token punctuation">.</span>document<span class="token punctuation">,</span> <span class="token string">"mousedown"</span><span class="token punctuation">)</span> <span class="token operator">||></span> attachEvent <span class="token punctuation">(</span><span class="token keyword">fun</span> ev <span class="token operator">-></span>
                <span class="token keyword">let</span> menuEl<span class="token punctuation">:</span> <span class="token class-name">Element</span> <span class="token operator">=</span> selfRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span>Value
                <span class="token keyword">if</span> <span class="token keyword">not</span><span class="token punctuation">(</span>menuEl<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>target <span class="token operator">:?></span> <span class="token class-name">_</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
                    printfn <span class="token string">"Clicked outside!"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">||</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        button
            <span class="token comment">// We can pass the ref object directly to the new RefHook prop</span>
            <span class="token comment">// to get a reference to the actual button element in the browser's doom</span>
            <span class="token punctuation">[</span> RefHook selfRef
              OnClick <span class="token punctuation">(</span><span class="token keyword">fun</span> _ <span class="token operator">-></span> printfn <span class="token string">"Clicked inside!"</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>
            <span class="token punctuation">[</span> str <span class="token string">"Click me"</span> <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
</code></pre>
<h2><a name="type-safe-css-props" class="anchor" href="#type-safe-css-props">Type-safe CSS props</a></h2><p>The following CSS props now accept a union type instead of a simple string for better type safety and discoverability. Thanks to Zaid-Ajaj for this contribution!</p>
<ul>
<li>Display</li>
<li>Position</li>
<li>TextAlign</li>
<li>AlignContent</li>
<li>AlignItems</li>
<li>AlignSelf</li>
</ul>
<pre><code class="language-fsharp">div <span class="token punctuation">[</span> Display DisplayOptions<span class="token punctuation">.</span>Flex <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
</code></pre>
<h2><a name="code-splitting" class="anchor" href="#code-splitting">Code Splitting</a></h2><p>Fable.React 5 also includes initial support for &quot;code splitting&quot;, that is, split your JS bundle in order to defer the download of parts that are not immediately accessible to the user (a very handy feature in Single Page Applications). So far, this has been quite tricky in Fable apps: we had to create a separate project and import it manually using a string. Fable.React 5 includes <code>FunctionComponent.Lazy</code> which can automatically defer the download of the code for a React component with minimum changes to your code.</p>
<blockquote>
<p>IMPORTANT: For this feature to work you need <code>fable-compiler</code> (npm) 2.3 or higher.</p>
</blockquote>
<pre><code class="language-fsharp"><span class="token comment">// About.fs</span>
<span class="token keyword">let</span> view <span class="token punctuation">(</span>props<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token operator">|</span> model<span class="token punctuation">:</span> <span class="token class-name">Model</span><span class="token punctuation">;</span> dispatch<span class="token punctuation">:</span> <span class="token class-name">Msg<span class="token operator">-></span>unit</span> <span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">..</span>

<span class="token comment">// Router.fs</span>
<span class="token keyword">let</span> AboutPage <span class="token operator">=</span>
    FunctionComponent<span class="token punctuation">.</span><span class="token function">Lazy</span><span class="token punctuation">(</span>
        About<span class="token punctuation">.</span>view<span class="token punctuation">,</span> <span class="token comment">// Pass a direct reference to the view function in the external file</span>
        fallback <span class="token operator">=</span> div <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>str <span class="token string">"Loading..."</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> view page <span class="token operator">=</span>
    <span class="token keyword">match</span> page <span class="token keyword">with</span>
    <span class="token operator">|</span> Home <span class="token operator">-></span> <span class="token computation-expression keyword">HomePage</span> <span class="token punctuation">{</span><span class="token operator">|</span> <span class="token operator">..</span> <span class="token operator">|</span><span class="token punctuation">}</span>
    <span class="token comment">// The code for About.fs will not be downloaded until</span>
    <span class="token comment">// the user selects the "About" page</span>
    <span class="token operator">|</span> About <span class="token operator">-></span> <span class="token computation-expression keyword">AboutPage</span> <span class="token punctuation">{</span><span class="token operator">|</span> <span class="token operator">..</span> <span class="token operator">|</span><span class="token punctuation">}</span>
</code></pre>
<p>You need also to make sure your webpack config includes the following:</p>
<pre><code class="language-js">    optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
        splitChunks<span class="token operator">:</span> <span class="token punctuation">{</span>
            chunks<span class="token operator">:</span> <span class="token string">"all"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
<p>As you&#39;ve seen, you need to pass a <strong>direct reference to the external function</strong> as first argument to <code>FunctionComponent.Lazy</code> (avoid indirections like pipes, etc) so Fable can detect the path to the external file. Also, <strong>avoid other static references to the external file</strong> as this will pull the external code into the main bundle ruining the effect of code splitting. In Elmish apps, you&#39;ll usually have to add a reference to the <code>update</code> function of the external component. This makes it difficult to completely defer the download of code for the whole component (the state logic will get bundled in the main chunk), but if you separate the code for the component&#39;s state and view into different files, as it&#39;s common practice in Elmish apps, you can still defer the download of external resources needed for the view like CSS, JS libraries, etc. Have a look at <a href="https://github.com/MangelMaxime/fulma-demo/pull/27">this PR for a real-world example</a>.</p>
<p>Another trick to avoid static references is to use an <strong>anonymous record for the props of the external view function</strong>, so Fable doesn&#39;t need to refer to the constructor of a declared record when passing the props.</p>
<hr>
<p>Those are the most important new features in Fable.React 5 and I hope they help make your development experience with Fable and Elmish much more enjoyable. Looking forward to seeing the awesome projects you&#39;ll build with this!</p>
</div></div><div class="column"></div></div></div></div><footer style="background-color:dodgerblue"><div class="content"><p>Fable <a href="https://github.com/fable-compiler/Fable">source code</a> is licensed <a href="http://opensource.org/licenses/mit-license.php">MIT</a>.</p></div></footer><script>
document.addEventListener('DOMContentLoaded', function () {
  // burger
  var $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);
  if ($navbarBurgers.length > 0) {
    $navbarBurgers.forEach(function ($el) {
      $el.addEventListener('click', function () {
        var target = $el.dataset.target;
        var $target = document.getElementById(target);
        $el.classList.toggle('is-active');
        $target.classList.toggle('is-active');
      });
    });
  }
});</script></body></html>